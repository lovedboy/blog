<!DOCTYPE html>
<html lang="en">
<head>
          <title></title>
	    <link href='https://lovedboy.github.io/theme/css/notsobad.css' rel='stylesheet' type='text/css'>


        <meta charset="utf-8" />
        <link href="https://lovedboy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title=" Full Atom Feed" />
        <link href="https://lovedboy.github.io/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title=" Categories Atom Feed" />




</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://lovedboy.github.io/"> <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">home</a></li>
            <li><a href="/">links</a></li>
            <li><a href="/">about</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://lovedboy.github.io/blog/1970/01/01/monkey-patch.html" rel="bookmark"
         title="Permalink to Monkey patch">Monkey patch</a>
		 
    <abbr class="published" title="1970-01-01T00:00:00+08:00">
      1970-01-01 00:00
    </abbr>
		 </h2>
 
  </header>
    <div class="entry-content">
    <p>什么是Monkey patch呢？简单理解就是在程序运行时动态修改代码，而不是在磁盘上修改源代码。</p>
<p>那么Monkey patch有什么作用呢？<a href="https://en.wikipedia.org/wiki/Monkey_patch">维基</a>上的解释是:</p>
<blockquote>
<p>＊ Replace methods/attributes/functions at runtime, e.g. to stub out a function &gt;during testing;</p>
<p>＊ Modify/extend behaviour of a third-party product without maintaining a &gt;private copy of the source code;</p>
<p>＊ Apply a patch at runtime to the objects in memory, instead of the source &gt;code on disk;</p>
<p>＊ Distribute security or behavioural fixes that live alongside the original &gt;source code (an example of this would be distributing the fix as a plugin &gt;for the Ruby on Rails platform).</p>
</blockquote>
<p>Monkey patch的应用场景有哪些？我想到的主要是下面两点：</p>
<p>1，热升级。比如游戏行业中的不停服升级。    <br>
2，hack第三方库。比如给第三方库打漏洞补丁、自定义功能。</p>
<p>善于打Monkey patch是Python程序员提高生产力、能力进阶的必备技能之一。</p>
<p>说一下我用到的一个场景。</p>
<p>2014-12-08，七牛的域名qiniudn.com被数字拦截。导致装有360的PC都不能访问qiniudn.com上的图片。我司也是受害者。我测试发现七牛默认提供的qbox.me 的域名是没有被拦截的。于是我紧急给tornado的模版函数打了一个Monkey patch，将网页模版里面qiniudn.com全部替换为qbox.me这个域名。</p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">hot_fix_2014_12_08_patch</span><span class="p">():</span>

        <span class="kn">from</span> <span class="nn">tornado.template</span>  <span class="kn">import</span> <span class="n">Template</span>
        <span class="n">old_generate</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">generate</span>
        <span class="k">def</span> <span class="nf">hack_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">old_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;yy.qiniudn.com&quot;</span><span class="p">,</span> <span class="s2">&quot;xx.qbox.me&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">html</span>

        <span class="n">tornado</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">generate</span> <span class="o">=</span> <span class="n">hack_generate</span>
</pre></div>


<p><a href="http://stackoverflow.com/questions/5626193/what-is-a-monkey-patch">stackoverflow上关于Monkey patch的讨论</a></p>
<p><img alt="http://ww2.sinaimg.cn/large/79565610gw1etwwmkgxifj20jk0cw0v3.jpg" src="http://ww2.sinaimg.cn/large/79565610gw1etwwmkgxifj20jk0cw0v3.jpg"> </p>
<p>图片来自网络。</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                By <a href="http://github.com/lovedboy" target="_blank">@lovedb0y</a>
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>