<!DOCTYPE html>
<html lang="en">
<head>
          <title></title>
	    <link href='https://lovedboy.github.io/theme/css/notsobad.css' rel='stylesheet' type='text/css'>


        <meta charset="utf-8" />
        <link href="https://lovedboy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title=" Full Atom Feed" />
        <link href="https://lovedboy.github.io/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title=" Categories Atom Feed" />




</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://lovedboy.github.io/"> <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">home</a></li>
            <li><a href="/">links</a></li>
            <li><a href="/">about</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://lovedboy.github.io/blog/1970/01/01/mv.html" rel="bookmark"
         title="Permalink to mv">mv</a>
		 
    <abbr class="published" title="1970-01-01T00:00:00+08:00">
      1970-01-01 00:00
    </abbr>
		 </h2>
 
  </header>
    <div class="entry-content">
    <h3>背景</h3>
<p>最近一个项目，需要限制日志文件的大小，所以会起一个线程去检测日志文件的大小，当到达限制大小后，拷贝日志文件，然后将日志文件清空。</p>
<p>代码大概长这样子：</p>
<div class="highlight"><pre><span></span>   // 写日志
   f = open(&quot;log.file&quot;)
   log(f, &quot;hello,world&quot;)
   .....

   // 其他线程监控日志文件大小

   size = f.stat().size()
   if size &gt; maxSize{
        CopyFileContent(&quot;log.file&quot;, &quot;log.file.bak&quot;)
        ftruncate(f.fd(), 0)
        f.lseek(0, 0)
   }
</pre></div>


<p>然后有同学问，为什么不直接用mv？</p>
<h3>MV</h3>
<p>我们先了解一下mv怎么实现的。</p>
<p><code>mv source target</code></p>
<ul>
<li>
<p>当<code>source</code>和<code>target</code>在同一个文件系统上是，mv仅仅执行<code>rename()</code>系统调用，文件本身(inode)是不会改变的，仅仅改变目录的内容，新的文件<code>target</code>还是指向以前的inode。</p>
</li>
<li>
<p>当<code>source</code>和<code>target</code>在不同的文件系统上，mv会copy文件内容，在新文件系统上创建文件，然后调用unlink删除源文件。</p>
</li>
</ul>
<p>我们知道当调用unlink删除文件时，如果有进程正在访问那个文件，内核就不会实际删除文件，所以常常利用这个特性来创建临时文件。</p>
<p>当处于第一种情况时，日志还是会往<code>target</code>上面写，并且你可以通过<code>tail -f</code>来实时查看日志输出，
当处于第二种情况时，你通过ls已经找不到日志文件了，但是文件本身（inode）还是存在的，进程还是在往文件里面写。</p>
<h3>验证</h3>
<p>用下面的程序验证第一种情况：</p>
<div class="highlight"><pre><span></span><span class="n">mport</span> <span class="n">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>


<p>程序运行时，<code>mv test.txt test.txt2</code>，你可以看到后续的输出被追加到了test.txt2上面。</p>
<p>验证第二种情况：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;test.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv test.txt /tmp/test.txt&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">line</span><span class="p">,</span>
</pre></div>


<p>保证程序的当前目录和/tmp不在同一个文件系统下面。</p>
<p>你会发现虽然父进程虽然调用了mv命令，但是子进程在睡眠唤醒后，还是会输出<code>1234</code>，也就是说文件本身并没有被删除。</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                By <a href="http://github.com/lovedboy" target="_blank">@lovedb0y</a>
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>