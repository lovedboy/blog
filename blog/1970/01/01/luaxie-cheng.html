<!DOCTYPE html>
<html lang="en">
<head>
          <title></title>
	    <link href='https://lovedboy.github.io/theme/css/notsobad.css' rel='stylesheet' type='text/css'>


        <meta charset="utf-8" />
        <link href="https://lovedboy.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title=" Full Atom Feed" />
        <link href="https://lovedboy.github.io/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title=" Categories Atom Feed" />




</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://lovedboy.github.io/"> <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">home</a></li>
            <li><a href="/">links</a></li>
            <li><a href="/">about</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://lovedboy.github.io/blog/1970/01/01/luaxie-cheng.html" rel="bookmark"
         title="Permalink to lua协程">lua协程</a>
		 
    <abbr class="published" title="1970-01-01T00:00:00+08:00">
      1970-01-01 00:00
    </abbr>
		 </h2>
 
  </header>
    <div class="entry-content">
    <h3>概念</h3>
<p>协程并不是Lua独有的东西，很有语言实现了协程，比如Go、Python等。协程是一种类似于线程的东西，我们可以将它理解为用户态的线程，协程的调度是由开发者控制的，一个线程只能同时运行一个协程，非并行执行，线程是由操作系统调度的，如果有多核的话，是可以并行执行的。</p>
<h3>主要函数</h3>
<p>Lua协程几个主要函数:</p>
<p><code>coroutine.create</code> - 创建协程</p>
<p><code>coroutine.status</code> - 查看协程状态</p>
<p><code>coroutine.resume</code> - 执行协程</p>
<p><code>coroutine.yield</code> - 挂起协程</p>
<p>有两个需要注意的地方：</p>
<ul>
<li>
<p>resume 执行完协程函数或者中途被挂起（yield）时，会有返回值返回，第一个值是 true，表示执行没有错误。如果是被 yield 挂起暂停，yield 函数有参数传入的话，这些参数会接着第一个值后面一并返回</p>
</li>
<li>
<p>resume(val...) 如果是开始执行，val1 及之后的值都作为参数传递给协程体函数；如果是恢复执行，val1 及之后的值都作为 yield 的返回值传递。</p>
</li>
</ul>
<p>看下面的代码:</p>
<div class="highlight"><pre><span></span><span class="o">!</span><span class="err">/usr/local/bin/lua</span>

<span class="kd">function</span> <span class="nx">greet</span><span class="p">()</span>

    <span class="nx">a</span> <span class="o">=</span> <span class="nx">coroutine</span><span class="p">.</span><span class="nx">yield</span><span class="p">(</span><span class="s2">&quot;hello,wrold&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">a</span><span class="o">+</span><span class="mi">1</span>
<span class="nx">end</span>

<span class="nx">co</span> <span class="o">=</span> <span class="nx">coroutine</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">greet</span><span class="p">)</span>

<span class="nx">print</span><span class="p">(</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">co</span><span class="p">))</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">&quot;step1&quot;</span><span class="p">)</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">resume</span><span class="p">(</span><span class="nx">co</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">))</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">co</span><span class="p">))</span>
<span class="nx">print</span><span class="p">(</span><span class="s2">&quot;step2&quot;</span><span class="p">)</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">resume</span><span class="p">(</span><span class="nx">co</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">coroutine</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">co</span><span class="p">))</span>
</pre></div>


<p>程序输出：</p>
<div class="highlight"><pre><span></span>suspended  
step1  
true    hello,wrold  
suspended  
step2  
true    2.0  
dead
</pre></div>


<h3>生产者和消费者</h3>
<p>用协程实现一个经典的生产者和消费者：
生产者负责读取输入、消费者打印输出。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#!/usr/local/bin/lua</span>

<span class="kr">function</span> <span class="nf">producer</span><span class="p">()</span>
    <span class="kr">return</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
        <span class="kr">while</span> <span class="kc">true</span> <span class="kr">do</span>
            <span class="kd">local</span> <span class="n">line</span> <span class="o">=</span> <span class="nb">io.read</span><span class="p">()</span>
            <span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="kr">end</span>
    <span class="kr">end</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="kr">while</span> <span class="kc">true</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">status</span><span class="p">,</span><span class="n">line</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="kr">if</span> <span class="n">status</span> <span class="kr">then</span>
            <span class="nb">io.write</span><span class="p">(</span><span class="s2">&quot;INPUT:&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="kr">else</span>
            <span class="kr">break</span>
        <span class="kr">end</span>
    <span class="kr">end</span>
<span class="kr">end</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">producer</span><span class="p">()</span>
<span class="n">consumer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>执行：</p>
<p><code>line=1;while true; do echo "hello,world $line";sleep 1;let line=line+1; done| ./producer.lua</code></p>
<p>输出：</p>
<div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">1</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">2</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">3</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">4</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">5</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">6</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">7</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">8</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">9</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">10</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">11</span>
<span class="n">INPUT</span><span class="o">:</span><span class="n">hello</span><span class="o">,</span><span class="n">world</span> <span class="mi">12</span>
</pre></div>


<p>Python用yield实现协程和Lua很多相似的地方，下面是一个Python的实现：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">line</span>

<span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;INPUT:&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">,</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">producer</span><span class="p">()</span>
<span class="n">consumer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>


<p>相比用两个线程来模拟生产者和消费者是不是简单多了，而且还不用考虑加锁，因为整个流程都是非抢占式的:）</p>
<h3>并发</h3>
<p>单线程要实现并发肯定是靠非阻塞或者异步IO了。Linux上的实现有<code>select</code>、<code>poll</code>和现在的<code>epoll</code>。select、poll是轮询机制、epoll是事件通知机制。</p>
<p>用协程模拟select来实现并发。</p>
<p>访问 http://httpbin.org/delay/3，这个请求响应时间为3S。</p>
<p>完整代码见这里<a href="https://gist.github.com/lovedboy/f12c0ddf485eb1a05322">协程模拟select来实现并发</a></p>
<p>看5次请求所需时间：</p>
<div class="highlight"><pre><span></span>worker0 start....       /delay/3
worker1 start....       /delay/3
worker2 start....       /delay/3
worker3 start....       /delay/3
worker4 start....       /delay/3
worker0 done...
worker1 done...
worker2 done...
worker3 done...
worker4 done...
start at:       21:42:59
end at: 21:43:04
</pre></div>


<p>花费5s左右。</p>
<p>30次请求测试：</p>
<div class="highlight"><pre><span></span>.....
worker27        done...
worker29        done...
worker28        done...
start at:       21:45:40
end at: 21:45:54
</pre></div>


<p>花费14s左右。</p>
<p><a href="https://gist.github.com/lovedboy/86d7a8b903fb7028a3a9">Python的实现</a>。</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                By <a href="http://github.com/lovedboy" target="_blank">@lovedb0y</a>
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>